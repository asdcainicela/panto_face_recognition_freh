# ============================================================================
# PANTO FACE RECOGNITION - 4K (3840x2160)
# MÁXIMA CALIDAD - Requiere GPU potente
# ============================================================================
# 
# Escenario: Cámara 4K en puerta de entrada con zoom
# Resolución: 3840x2160 (2160p)
# Performance esperado: 18-22 FPS, precisión 97-99%
# GPU mínima: RTX 3060 / RTX 2080
#
# ============================================================================

[project]
name = "panto_door_access_4k"
version = "1.0.0"
scenario = "entrance_door_4k"

# ============================================================================
# CÁMARA
# ============================================================================

[camera]
resolution = [3840, 2160]
fps_target = 20
device_id = 0
backend = "gstreamer"
buffer_size = 1
drop_old_frames = true

# ROI opcional (desactivado por defecto en 4K)
[camera.roi]
enabled = false  # Cambia a true si quieres procesar solo zona de puerta
x = 960          # 25% desde izquierda
y = 540          # 25% desde arriba
width = 1920     # 50% del ancho
height = 1080    # 50% del alto

# ============================================================================
# DETECCIÓN
# ============================================================================

[detection]
model = "retinaface"
model_path = "models/retinaface_mobilenet.onnx"
backend = "onnx"
use_gpu = true
num_threads = 4

# En 4K los rostros son grandes, threshold más estricto
min_face_size = 100        # Rostros grandes incluso lejos
confidence_threshold = 0.60
nms_threshold = 0.4

# ============================================================================
# TRACKING
# ============================================================================

[tracking]
algorithm = "bytetrack"
use_gpu = false
max_tracks = 5
max_age = 30
min_hits = 3
direction_filter = "approaching"
ignore_leaving = true
min_movement = 8

# ============================================================================
# SUPER-RESOLUTION
# ============================================================================

[superresolution]
# En 4K casi nunca necesario
enabled = false
conditional_threshold = 150  # Solo aplicar si rostro < 150px (raro en 4K)
model = "realesr_x2"
model_path = "models/realesr_x2.onnx"
target_size = 300
use_gpu = true
skip_if_sharp = true
sharpness_threshold = 0.8
max_sr_per_second = 5
batch_size = 1

# ============================================================================
# RECONOCIMIENTO
# ============================================================================

[recognition]
model = "arcface_r100"
model_path = "models/arcface_r100.onnx"
backend = "onnx"
use_gpu = true
embedding_size = 512
strategy = "multi_frame_voting"
voting_method = "weighted_average"
min_frames = 15  # Más frames disponibles en 4K
alignment_method = "similarity"
normalize_embeddings = true
min_face_size_for_match = 120
confidence_threshold = 0.30  # Más estricto por mejor calidad
min_face_quality = 0.6
max_face_angle = 40

# ============================================================================
# ZONAS - Adaptadas para 4K
# ============================================================================
# En 4K: 10 dedos = 3840px
# Cabeza más cerca: 1 dedo = 384px → rostro ~268px
# Cabeza más lejos: 1/3 dedo = 128px → rostro ~90px

[zones]
enabled = true
draw_zones = false

# ZONA 1: Lejos (90-150px) - Tracking ligero
[zones.far]
min_face_size = 90
max_face_size = 150
action = "track_only"  # Solo seguir, aún no reconocer
priority = "low"
confidence_threshold = 0.55
frame_weight = 0.2  # Poco peso en votación

# ZONA 2: Acercamiento (150-220px) - Acumular embeddings
[zones.approach]
min_face_size = 150
max_face_size = 220
action = "accumulate"
apply_sr = false  # No necesario en 4K
priority = "medium"
confidence_threshold = 0.40
frame_weight = 0.5

# ZONA 3: Óptima (220-350px) - DECIDIR aquí ⭐
[zones.optimal]
min_face_size = 220
max_face_size = 350
action = "definitive_match"
apply_sr = false
priority = "high"
confidence_threshold = 0.30  # Estricto por alta calidad
frame_weight = 1.0
trigger_decision = true

# ZONA 4: Muy cerca (>350px) - Verificación final
[zones.close]
min_face_size = 350
action = "verify_and_log"
apply_sr = false
priority = "critical"
confidence_threshold = 0.25
frame_weight = 1.0

# ============================================================================
# MATCHING
# ============================================================================

[matching]
database_path = "data/known_faces.db"
database_type = "sqlite"
distance_metric = "cosine"
adaptive_threshold = true
unknown_person_threshold = 0.55  # Más estricto en 4K
frame_weight_by_size = true
frame_weight_by_quality = true

# ============================================================================
# ACCIONES
# ============================================================================

[actions]
log_access_events = true
access_log_path = "logs/access_events.db"
save_best_frame = true
save_all_frames = false
frames_path = "data/captures/{date}/{person_id}"
image_format = "jpg"
image_quality = 95  # Mayor calidad en 4K

[actions.webhook]
enabled = false
url = "http://192.168.1.10:5000/access"
method = "POST"
timeout = 5
on_match = true
on_unknown = false

[actions.mqtt]
enabled = false
broker = "192.168.1.10"
port = 1883
topic_prefix = "panto/access"
qos = 1

# ============================================================================
# OUTPUT
# ============================================================================

[output]
display_output = true
output_resolution = "1080p"  # Escalar a 1080p para display
window_name = "Panto Access Control 4K"
draw_detections = true
draw_tracks = true
draw_zones = false
draw_roi = false
draw_ids = true
draw_confidence = true
draw_fps = true

colors = {
    known = [0, 255, 0],
    unknown = [0, 0, 255],
    tracking = [255, 255, 0],
    roi = [255, 0, 255]
}

[output.video]
enabled = false
output_path = "recordings/{date}.mp4"
codec = "h264"
fps = 20

# ============================================================================
# BASE DE DATOS
# ============================================================================

[database]
path = "data/panto.db"
auto_vacuum = true
journal_mode = "WAL"
auto_backup = true
backup_interval = 86400
backup_path = "backups/panto_{date}.db"
retention_days = 90
cleanup_on_startup = true

# ============================================================================
# PERFORMANCE
# ============================================================================

[performance]
use_tensorrt = false
use_openvino = false
use_coreml = false
detector_threads = 3
recognition_threads = 3
sr_threads = 1
io_threads = 2
max_queue_size = 30
clear_queue_on_full = true
embedding_cache_size = 1000
enable_motion_detection = false
motion_threshold = 0.05
sleep_after_seconds = 60

# ============================================================================
# LOGGING
# ============================================================================

[logging]
level = "INFO"
log_to_file = true
log_to_console = true
log_path = "logs/panto_{date}.log"
rotate_logs = true
max_log_size_mb = 20
backup_count = 7
log_detections = false
log_trackings = false
log_recognitions = true
log_performance = true

# ============================================================================
# DEBUG
# ============================================================================

[debug]
enabled = false
save_debug_images = false
debug_path = "debug/{date}"
profile_performance = false
verbose_logging = false

# ============================================================================
# NOTAS 4K
# ============================================================================
#
# VENTAJAS:
# - Rostros MUY grandes (220-350px en zona óptima)
# - No necesitas SR prácticamente nunca
# - Máxima precisión (97-99%)
# - Mejor calidad de embeddings
#
# DESVENTAJAS:
# - Requiere GPU potente (RTX 3060+)
# - FPS más bajo (18-22)
# - Mayor consumo de recursos
# - Mayor tamaño de archivos guardados
#
# RECOMENDADO PARA:
# - Instalaciones de alta seguridad
# - Cuando precisión es crítica
# - Hardware disponible es potente
#
# ============================================================================